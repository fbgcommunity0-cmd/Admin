<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - üÖêüÖü ùóßùóòùóñùóõ ‚ö° ùó†ùóîùó•ùóûùóòùóß üõçÔ∏è</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .sidebar { background-color: #111827; color: #d1d5db; }
        .sidebar a { border-left: 3px solid transparent; transition: all 0.2s; }
        .sidebar a:hover { background-color: #374151; }
        .sidebar a.active { background-color: #1d4ed8; color: white; border-left-color: #60a5fa; }
        .stat-card { background-color: white; border-radius: 0.75rem; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.5s; }
        .btn { padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 600; transition: all 0.2s; cursor: pointer; border: none; }
        .btn:active { transform: scale(0.95); }
        .btn:disabled { background-color: #9ca3af; cursor: not-allowed; }
        .btn-primary { background-color: #2563eb; color: white; }
        .btn-primary:hover { background-color: #1d4ed8; }
        .btn-success { background-color: #10b981; color: white; }
        .btn-danger { background-color: #ef4444; color: white; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #e5e7eb; word-break: break-word; }
        th { background-color: #f9fafb; font-weight: 600; color: #374151; text-transform: uppercase; font-size: 0.75rem; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 100; backdrop-filter: blur(4px); }
        .modal-content { background-color: white; padding: 1.5rem; border-radius: 0.5rem; max-width: 90%; width: 600px; max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="admin-login-view" class="min-h-screen flex items-center justify-center bg-gray-100">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md">
            <div class="text-center mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-16 w-16 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                </svg>
            </div>
            <h1 class="text-2xl font-bold text-center text-gray-900">üÖêüÖü ùóßùóòùóñùóõ ‚ö° ùó†ùóîùó•ùóûùóòùóß üõçÔ∏è Admin Login</h1>
            <input id="admin-email" type="email" placeholder="Admin Email" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            <input id="admin-password" type="password" placeholder="Password" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            <button id="admin-login-btn" class="w-full btn btn-primary">Login</button>
        </div>
    </div>

    <div id="admin-dashboard" class="hidden">
        <div class="flex h-screen">
            <aside class="sidebar w-64 flex-shrink-0 overflow-y-auto">
                <div class="p-4 text-xl font-bold text-white">üÖêüÖü ùóßùóòùóñùóõ ‚ö° ùó†ùóîùó•ùóûùóòùóß üõçÔ∏è</div>
                <nav class="mt-8">
                    <a href="#" class="nav-link block py-3 px-4" data-page="dashboard-page"><i data-lucide="layout-dashboard" class="inline-block w-5 h-5 mr-2"></i>Dashboard</a>
                    <a href="#" class="nav-link block py-3 px-4" data-page="users-page"><i data-lucide="users" class="inline-block w-5 h-5 mr-2"></i>Users</a>
                    <a href="#" class="nav-link block py-3 px-4" data-page="notifications-page"><i data-lucide="send" class="inline-block w-5 h-5 mr-2"></i>Notifications</a>
                    <a href="#" class="nav-link block py-3 px-4" data-page="deposits-page"><i data-lucide="arrow-down-circle" class="inline-block w-5 h-5 mr-2"></i>Deposits</a>
                    <a href="#" class="nav-link block py-3 px-4" data-page="purchases-page"><i data-lucide="shopping-cart" class="inline-block w-5 h-5 mr-2"></i>Mail Purchases</a>
                    <a href="#" class="nav-link block py-3 px-4" data-page="stock-page"><i data-lucide="package-plus" class="inline-block w-5 h-5 mr-2"></i>Add Stock</a>
                    <a href="#" class="nav-link block py-3 px-4" data-page="manage-mails-page"><i data-lucide="search" class="inline-block w-5 h-5 mr-2"></i>Search Mails</a>
                    <a href="#" class="nav-link block py-3 px-4" data-page="bulk-tools-page"><i data-lucide="database-zap" class="inline-block w-5 h-5 mr-2"></i>Bulk Mail Tools</a>
                    <a href="#" class="nav-link block py-3 px-4" data-page="updates-page"><i data-lucide="megaphone" class="inline-block w-5 h-5 mr-2"></i>Manage Updates</a>
                    <a href="#" class="nav-link block py-3 px-4" data-page="support-page"><i data-lucide="life-buoy" class="inline-block w-5 h-5 mr-2"></i>Support Links</a>
                    <a href="#" class="nav-link block py-3 px-4" data-page="settings-page"><i data-lucide="settings" class="inline-block w-5 h-5 mr-2"></i>App Settings</a>
                    <a href="#" id="admin-logout-btn" class="block py-3 px-4 mt-8 text-red-400 hover:bg-red-500 hover:text-white"><i data-lucide="log-out" class="inline-block w-5 h-5 mr-2"></i>Logout</a>
                </nav>
            </aside>

            <main class="flex-1 p-8 overflow-y-auto bg-gray-100">
                <div id="dashboard-page" class="page">
                    <h1 class="text-3xl font-bold mb-6 text-gray-800">Dashboard</h1>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="stat-card p-6"><h2 class="text-gray-500 text-lg">PENDING DEPOSITS</h2><p id="pending-deposits" class="text-4xl font-bold mt-2 text-yellow-600">0</p></div>
                        <div class="stat-card p-6"><h2 class="text-gray-500 text-lg">TOTAL USERS</h2><p id="total-users" class="text-4xl font-bold mt-2 text-indigo-600">0</p></div>
                        <div class="stat-card p-6"><h2 class="text-gray-500 text-lg">USERS' TOTAL BALANCE</h2><p id="total-user-balance" class="text-4xl font-bold mt-2 text-purple-600">‡ß≥0</p></div>
                        <div class="stat-card p-6"><h2 class="text-gray-500 text-lg">TODAY'S SALE</h2><p id="today-sales-stat" class="text-4xl font-bold mt-2 text-green-600">‡ß≥0</p></div>
                        <div class="stat-card p-6 col-span-1 md:col-span-2 lg:col-span-4"><h2 class="text-gray-500 text-lg">TOTAL SALE</h2><p id="total-sales-stat" class="text-4xl font-bold mt-2 text-rose-600">‡ß≥0</p></div>
                    </div>
                    <div class="grid grid-cols-1 gap-8 mt-8">
                        <div class="stat-card p-6">
                            <h2 class="text-xl font-bold mb-4 text-gray-700">Available Mail Stock</h2>
                            <div id="stock-overview-container" class="space-y-3">
                                <p>Loading stock data...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="users-page" class="page">
                    <h1 class="text-3xl font-bold mb-6 text-gray-800">User Management</h1>
                    <div class="mb-4"><input type="text" id="user-search" class="w-full max-w-sm px-4 py-2 border rounded-lg" placeholder="Search by name or User ID..."></div>
                    <div class="bg-white shadow-md rounded-lg overflow-x-auto">
                        <table class="min-w-full">
                            <thead><tr><th>Name</th><th>User ID</th><th>Balance</th><th>Status</th><th>Actions</th></tr></thead>
                            <tbody id="users-table-body"></tbody>
                        </table>
                    </div>
                </div>

                <div id="notifications-page" class="page">
                    <h1 class="text-3xl font-bold mb-6 text-gray-800">Send Notifications</h1>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="stat-card p-6">
                            <h2 class="text-xl font-bold mb-4">Send to All Users (Broadcast)</h2>
                            <div class="space-y-4">
                                <div><label class="block font-semibold">Title</label><input type="text" id="broadcast-title" class="w-full px-3 py-2 border rounded"></div>
                                <div><label class="block font-semibold">Message</label><textarea id="broadcast-message" rows="4" class="w-full px-3 py-2 border rounded"></textarea></div>
                                <button id="send-broadcast-btn" class="w-full btn btn-primary">Send Broadcast</button>
                            </div>
                        </div>
                        <div class="stat-card p-6">
                            <h2 class="text-xl font-bold mb-4">Send to Individual User</h2>
                             <div class="space-y-4">
                                <div><label class="block font-semibold">Recipient User ID</label><input type="text" id="direct-user-id" class="w-full px-3 py-2 border rounded" placeholder="Enter Telegram User ID"></div>
                                <div><label class="block font-semibold">Title</label><input type="text" id="direct-title" class="w-full px-3 py-2 border rounded"></div>
                                <div><label class="block font-semibold">Message</label><textarea id="direct-message" rows="4" class="w-full px-3 py-2 border rounded"></textarea></div>
                                <button id="send-direct-btn" class="w-full btn btn-primary">Send Direct Message</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="deposits-page" class="page">
                     <h1 class="text-3xl font-bold mb-6 text-gray-800">Pending Deposit Requests</h1>
                     <div class="bg-white shadow-md rounded-lg overflow-x-auto">
                        <table>
                            <thead><tr><th>User Name</th><th>Amount (BDT)</th><th>Method</th><th>TrxID</th><th>Time</th><th>Actions</th></tr></thead>
                            <tbody id="deposits-table-body"></tbody>
                        </table>
                    </div>
                </div>

                <div id="purchases-page" class="page">
                    <h1 class="text-3xl font-bold mb-6 text-gray-800">Mail Purchase History</h1>
                    <div class="mb-4">
                        <input type="text" id="purchase-search" class="w-full max-w-sm px-4 py-2 border rounded-lg" placeholder="Search by Sale ID or User ID...">
                    </div>
                    <div class="bg-white shadow-md rounded-lg overflow-x-auto">
                       <table>
                           <thead><tr><th>Sale ID</th><th>Date</th><th>User Name</th><th>Mail Type</th><th>Mail Details</th><th>Cost</th></tr></thead>
                           <tbody id="purchases-table-body"></tbody>
                       </table>
                   </div>
                </div>

                <div id="stock-page" class="page">
                    <h1 class="text-3xl font-bold mb-6 text-gray-800">Add Mail Stock</h1>
                    <div class="stat-card p-6">
                        <h3 class="font-semibold text-xl text-gray-800 mb-4">Add New Mails</h3>
                        <p class="text-sm text-gray-600 mb-4">‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü: <code class="bg-gray-200 p-1 rounded text-gray-700">email|password|refresh_token|client_id</code></p>
                        <div class="mb-4">
                            <label for="mail-type-select-add" class="block text-sm font-medium text-gray-700 mb-1">Select Mail Type</label>
                            <select id="mail-type-select-add" class="w-full p-3 rounded-lg border border-gray-300"></select>
                        </div>
                        <div class="mb-4">
                            <label for="mail-data-textarea" class="block text-sm font-medium text-gray-700 mb-1">Mail Data (one per line)</label>
                            <textarea id="mail-data-textarea" rows="12" placeholder="mail@example.com|password|refresh_token|client_id" class="w-full p-3 rounded-lg border border-gray-300 font-mono text-xs"></textarea>
                        </div>
                        <button id="add-mails-btn" class="btn btn-primary w-full">Add Mails to Stock</button>
                    </div>
                </div>
                
                <div id="manage-mails-page" class="page">
                    <h1 class="text-3xl font-bold mb-6 text-gray-800">Search Individual Mails</h1>
                    <div class="stat-card p-6">
                        <p class="text-gray-600 mb-4">‡¶Ø‡ßá‡¶ï‡ßã‡¶®‡ßã ‡¶Æ‡ßá‡¶á‡¶≤ ‡¶∏‡ßç‡¶ü‡¶ï‡ßá ‡¶¨‡¶æ ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø‡¶∞ ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏‡ßá ‡¶ñ‡ßÅ‡¶Å‡¶ú‡¶§‡ßá ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶á‡¶Æ‡ßá‡¶≤ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶¶‡¶ø‡ßü‡ßá ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
                        <div class="flex items-center space-x-2 mb-4">
                             <select id="global-mail-search-type" class="p-3 border rounded-lg border-gray-300">
                                <option value="stock">Search in Stock</option>
                                <option value="sale">Search in Sales</option>
                            </select>
                            <input type="text" id="global-mail-search-input" class="w-full p-3 rounded-lg border border-gray-300" placeholder="Search by full email address...">
                            <button id="global-mail-search-btn" class="btn btn-primary">Search</button>
                        </div>
                        <div id="global-mail-search-results-container" class="mt-6">
                            <p class="text-gray-500">Select a category, enter an email, and click search.</p>
                        </div>
                    </div>
                </div>
                
                <div id="bulk-tools-page" class="page">
                    <h1 class="text-3xl font-bold mb-6 text-gray-800">Bulk Mail Tools</h1>
                    <div class="stat-card p-6">
                        <p class="text-gray-600 mb-4">‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø‡¶∞ ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø ‡¶®‡¶æ ‡¶π‡¶ì‡ßü‡¶æ (Unsold) ‡¶Æ‡ßá‡¶á‡¶≤ ‡¶è‡¶ï‡¶∏‡¶æ‡¶•‡ßá ‡¶ï‡¶™‡¶ø ‡¶¨‡¶æ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®‡•§ <strong class="text-red-600">‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶¨‡¶æ‡¶ü‡¶® ‡¶∏‡¶æ‡¶¨‡¶ß‡¶æ‡¶®‡ßá ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</strong></p>
                        <div id="bulk-tools-container" class="space-y-4">
                            <p class="text-gray-500">Loading mail categories...</p>
                        </div>
                    </div>
                </div>

                <div id="updates-page" class="page">
                    <h1 class="text-3xl font-bold mb-6 text-gray-800">Manage Updates</h1>
                     <div class="stat-card p-6">
                        <h2 class="text-xl font-bold mb-4" id="update-form-title">Add New Update</h2>
                        <form id="update-form" class="space-y-4">
                            <input type="hidden" id="update-id">
                            <div><label class="block font-semibold">Title</label><input type="text" id="update-title" class="w-full px-3 py-2 border rounded" required></div>
                            <div><label class="block font-semibold">Content / Message</label><textarea id="update-content" rows="4" class="w-full px-3 py-2 border rounded"></textarea></div>
                            <div><label class="block font-semibold">Image URL</label><input type="text" id="update-imageUrl" class="w-full px-3 py-2 border rounded"></div>
                            <div class="flex space-x-2">
                                <button type="submit" id="update-submit-btn" class="w-full btn btn-primary">Post Update</button>
                                <button type="button" id="update-cancel-btn" class="w-full btn bg-gray-300 hidden">Cancel</button>
                            </div>
                        </form>
                    </div>
                    <div class="bg-white shadow-md rounded-lg overflow-x-auto mt-8">
                        <h2 class="text-xl font-bold p-4">Current Updates</h2>
                        <table>
                            <thead><tr><th>Title</th><th>Posted On</th><th>Actions</th></tr></thead>
                            <tbody id="updates-table-body"></tbody>
                        </table>
                    </div>
                </div>
                
                <div id="support-page" class="page">
                    <h1 class="text-3xl font-bold mb-6 text-gray-800">Manage Support Links</h1>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-1">
                            <div class="stat-card p-6">
                                <h2 class="text-xl font-bold mb-4" id="support-form-title">Add New Support Link</h2>
                                <form id="support-form" class="space-y-4">
                                    <input type="hidden" id="support-id">
                                    <div><label class="block font-semibold">Channel Name</label><input type="text" id="support-name" class="w-full px-3 py-2 border rounded" placeholder="e.g., Telegram Support" required></div>
                                    <div><label class="block font-semibold">Icon URL</label><input type="url" id="support-iconUrl" class="w-full px-3 py-2 border rounded" placeholder="https://i.postimg.cc/....png" required></div>
                                    <div><label class="block font-semibold">Link URL</label><input type="url" id="support-link" class="w-full px-3 py-2 border rounded" placeholder="https://t.me/username" required></div>
                                    <div><label class="block font-semibold">Order</label><input type="number" id="support-order" class="w-full px-3 py-2 border rounded" value="0"></div>
                                    <div class="flex items-center space-x-2">
                                        <input type="checkbox" id="support-isActive" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                                        <label for="support-isActive" class="font-semibold">Is Active</label>
                                    </div>
                                    <div class="flex space-x-2">
                                        <button type="submit" id="support-submit-btn" class="w-full btn btn-primary">Save Link</button>
                                        <button type="button" id="support-cancel-btn" class="w-full btn bg-gray-300 hidden">Cancel</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        <div class="lg:col-span-2">
                            <div class="stat-card p-6">
                                <h2 class="text-xl font-bold mb-4">Current Support Links</h2>
                                <div id="support-links-list" class="space-y-3"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="settings-page" class="page">
                    <h1 class="text-3xl font-bold mb-6 text-gray-800">App Settings</h1>
                    <div class="space-y-8">
                        <div class="stat-card p-6">
                             <h2 class="text-xl font-bold mb-4">Deposit Rules</h2>
                             <p class="text-sm text-gray-500 mb-4">‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶®‡¶ø‡ßü‡¶Æ‡¶ó‡ßÅ‡¶≤‡ßã ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßá ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø ‡¶™‡ßç‡¶∞‡¶≠‡¶æ‡¶¨ ‡¶´‡ßá‡¶≤‡¶¨‡ßá‡•§</p>
                             <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Minimum Deposit Amount</label>
                                    <input type="number" id="setting-min-deposit" class="mt-1 w-full p-2 border rounded-md" placeholder="e.g., 50">
                                </div>
                             </div>
                        </div>

                        <div class="stat-card p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-bold">Mail Shop Items</h2>
                                <button id="add-mail-type-btn" class="btn btn-primary">Add New Mail Type</button>
                            </div>
                            <p class="text-sm text-gray-500 mb-4">‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßá ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø ‡¶π‡¶ì‡ßü‡¶æ ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶Æ‡ßá‡¶á‡¶≤ ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®‡•§ ‡¶∏‡¶ï‡¶≤ ‡¶§‡¶•‡ßç‡¶Ø ‡¶∏‡¶†‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá ‡¶¶‡¶ø‡¶®‡•§</p>
                            <div id="mail-types-container" class="space-y-6"></div>
                        </div>
                    </div>
                    <div class="mt-8">
                        <button id="save-all-settings-btn" class="w-full lg:w-auto btn btn-primary px-8 py-3 text-lg">Save All Settings</button>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <div id="balance-modal" class="modal-overlay hidden">
        <div class="modal-content !w-[500px]">
            <h2 id="balance-modal-title" class="text-2xl font-bold mb-6">Update Balance</h2>
            <form id="balance-form" class="space-y-4">
                <input type="hidden" id="balance-user-id">
                <p class="text-lg">Current Balance: <span id="current-balance-display" class="font-bold"></span></p>
                <div>
                    <label class="block font-semibold">Action</label>
                    <select id="balance-action" class="w-full p-2 border rounded">
                        <option value="add">Add to Balance</option>
                        <option value="deduct">Deduct from Balance</option>
                        <option value="set">Set New Balance</option>
                    </select>
                </div>
                <div>
                    <label class="block font-semibold">Amount (BDT)</label>
                    <input type="number" id="balance-amount" step="0.01" class="w-full p-2 border rounded" required>
                </div>
                <div class="flex justify-end space-x-4 pt-4">
                    <button type="button" id="balance-modal-cancel" class="btn bg-gray-300">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Balance</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="custom-alert" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[200] p-4"><div class="bg-white rounded-lg p-6 w-full max-w-sm text-center shadow-xl"><p id="alert-message" class="mb-4 text-gray-800"></p><button id="alert-ok-btn" class="btn btn-primary px-6">OK</button></div></div>
    <div id="custom-confirm" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[200] p-4"><div class="bg-white rounded-lg p-6 w-full max-w-sm text-center shadow-xl"><p id="confirm-message" class="mb-6 text-gray-800 whitespace-pre-wrap"></p><div class="flex justify-center space-x-4"><button id="confirm-cancel-btn" class="btn bg-gray-300 text-gray-800 px-6">Cancel</button><button id="confirm-ok-btn" class="btn btn-danger px-6">Confirm</button></div></div></div>
    
    <script type="module">
        // --- DUAL FIREBASE CONFIGURATION ---
        // Config 1: For User Balance, Deposits, and Profiles (tech-mail-market)
        const firebaseConfigUser = {
          apiKey: "AIzaSyClz7XBgYHuiF70711CSb6DzDULzN4Okc8",
          authDomain: "tech-mail-market.firebaseapp.com",
          databaseURL: "https://tech-mail-market-default-rtdb.firebaseio.com",
          projectId: "tech-mail-market",
          storageBucket: "tech-mail-market.firebasestorage.app",
          messagingSenderId: "28333491796",
          appId: "1:28333491796:web:caa5daa598b72550830fc1"
        };
        
        // Config 2: For Mail Stock, Purchase History, App Config etc. (tmgbdsell)
        const firebaseConfigMail = {
          apiKey: "AIzaSyBtNIF0NbUsriMB7ZNrwfl_0hEyP6BpH6s",
          authDomain: "tmgbdsell.firebaseapp.com",
          databaseURL: "https://tmgbdsell-default-rtdb.firebaseio.com",
          projectId: "tmgbdsell",
          storageBucket: "tmgbdsell.firebasestorage.app",
          messagingSenderId: "711521693696",
          appId: "1:711521693696:web:f765e256d178fc1c2428e5"
        };
        
        const ADMIN_UIDS = ["H8Nrwo2lCOXVBTqTsynmAeOJSY52"]; 
        const TELEGRAM_BOT_TOKEN = "8185055021:AAFqmvM-DAtNTbcl8slFzUd_L3ejJ0a4XtI";

        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, query, where, onSnapshot, addDoc, serverTimestamp, deleteDoc, writeBatch, getDocs, runTransaction, orderBy, limit, getCountFromServer, increment, Timestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const userApp = initializeApp(firebaseConfigUser, "userApp");
        const mailApp = initializeApp(firebaseConfigMail, "mailApp");

        const auth = getAuth(userApp); 
        const dbUser = getFirestore(userApp);
        const dbMail = getFirestore(mailApp);

        const loginView = document.getElementById('admin-login-view');
        const dashboardView = document.getElementById('admin-dashboard');
        let appConfig = {};
        let activeListeners = {};
        let allPurchases = [];
        let allUsersMap = new Map();
        
        window.onload = () => {
            lucide.createIcons();
            setupEventListeners();
            onAuthStateChanged(auth, (user) => {
                if (user && ADMIN_UIDS.includes(user.uid)) {
                    loginView.style.display = 'none';
                    dashboardView.style.display = 'block';
                    fetchAllUsers();
                    navigateTo('dashboard-page');
                } else {
                    if (user) signOut(auth);
                    loginView.style.display = 'flex';
                    dashboardView.style.display = 'none';
                }
            });
        };
        
        function navigateTo(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId)?.classList.add('active');
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.toggle('active', link.dataset.page === pageId);
            });
            
            Object.values(activeListeners).forEach(unsubscribe => unsubscribe());
            activeListeners = {};

            const pageFunctions = {
                'dashboard-page': loadDashboardData,
                'users-page': () => loadUsers(),
                'deposits-page': loadDeposits,
                'purchases-page': loadMailPurchases,
                'stock-page': loadAddStockPage,
                'bulk-tools-page': loadBulkToolsPage,
                'updates-page': loadUpdates,
                'settings-page': loadSettings,
                'support-page': loadSupportLinks,
            };
            pageFunctions[pageId]?.();
            lucide.createIcons();
        }

        async function fetchAppConfig() {
            try {
                const configRef = doc(dbMail, "config", "main");
                const docSnap = await getDoc(configRef);
                const defaults = { mails: [], minDeposit: 50 };
                appConfig = docSnap.exists() ? { ...defaults, ...docSnap.data() } : defaults;
                return appConfig;
            } catch (error) {
                console.error("Error fetching app config:", error);
                showAlert("Could not load app configuration.");
                return { mails: [] };
            }
        }

        async function fetchAllUsers() {
            const usersSnap = await getDocs(collection(dbUser, "users"));
            allUsersMap.clear();
            usersSnap.forEach(doc => allUsersMap.set(doc.id, doc.data()));
        }

        function setupEventListeners() {
            document.getElementById('admin-login-btn').addEventListener('click', handleAdminLogin);
            document.getElementById('admin-logout-btn').addEventListener('click', () => signOut(auth));
            document.getElementById('user-search').addEventListener('input', (e) => loadUsers(e.target.value));
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => { e.preventDefault(); navigateTo(link.dataset.page); });
            });
            document.getElementById('send-broadcast-btn').addEventListener('click', handleBroadcastNotification);
            document.getElementById('send-direct-btn').addEventListener('click', handleDirectNotification);
            document.getElementById('update-form').addEventListener('submit', handleUpdateSubmit);
            document.getElementById('update-cancel-btn').addEventListener('click', resetUpdateForm);
            document.getElementById('save-all-settings-btn').addEventListener('click', saveAllSettings);
            document.getElementById('add-mail-type-btn').addEventListener('click', () => addMailTypeToUI());
            document.getElementById('add-mails-btn').addEventListener('click', handleAddMails);
            document.getElementById('balance-modal-cancel').addEventListener('click', () => document.getElementById('balance-modal').classList.add('hidden'));
            document.getElementById('balance-form').addEventListener('submit', handleBalanceUpdate);
            document.getElementById('alert-ok-btn').onclick = () => document.getElementById('custom-alert').classList.add('hidden');
            document.getElementById('support-form').addEventListener('submit', handleSupportFormSubmit);
            document.getElementById('support-cancel-btn').addEventListener('click', resetSupportForm);
            document.getElementById('purchase-search').addEventListener('input', (e) => renderPurchases(e.target.value));
            document.getElementById('global-mail-search-btn').addEventListener('click', handleGlobalMailSearch);
        }

        async function handleAdminLogin() {
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;
            if(!email || !password) return showAlert('Please enter email and password.');
            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                if (!ADMIN_UIDS.includes(userCredential.user.uid)) {
                    await signOut(auth);
                    showAlert("You are not authorized to access this panel.");
                }
            } catch (error) { showAlert("Login failed: " + error.message); }
        }
        
        async function loadDashboardData() {
            try {
                const [ usersSnap, pendingDepositsSnap, allPurchasesSnap ] = await Promise.all([
                    getDocs(collection(dbUser, "users")),
                    getCountFromServer(query(collection(dbUser, "deposits"), where("status", "==", "pending"))),
                    getDocs(collection(dbMail, "mail_purchases"))
                ]);

                document.getElementById('total-users').textContent = usersSnap.size;
                const totalUserBalance = usersSnap.docs.reduce((sum, doc) => sum + (doc.data().balance || 0), 0);
                document.getElementById('total-user-balance').textContent = `‡ß≥${totalUserBalance.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                
                document.getElementById('pending-deposits').textContent = pendingDepositsSnap.data().count;

                const startOfToday = new Date();
                startOfToday.setHours(0, 0, 0, 0);
                const todayTimestamp = Timestamp.fromDate(startOfToday);

                let totalSaleIncome = 0;
                let todaySaleIncome = 0;

                allPurchasesSnap.docs.forEach(doc => {
                    const purchase = doc.data();
                    totalSaleIncome += purchase.cost;
                    if (purchase.purchasedAt >= todayTimestamp) {
                        todaySaleIncome += purchase.cost;
                    }
                });

                document.getElementById('total-sales-stat').textContent = `‡ß≥${totalSaleIncome.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                document.getElementById('today-sales-stat').textContent = `‡ß≥${todaySaleIncome.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;

            } catch (error) {
                console.error("Error loading dashboard data:", error);
                showAlert("Failed to load dashboard statistics.");
            }
            loadStockOverview();
        }

        async function loadStockOverview() {
            const container = document.getElementById('stock-overview-container');
            container.innerHTML = `<p>Loading stock data...</p>`;
            await fetchAppConfig();
            if (!appConfig.mails || appConfig.mails.length === 0) { container.innerHTML = `<p>No mail types configured in settings.</p>`; return; }
            const stockPromises = appConfig.mails.map(async (mail) => {
                try {
                    const stockQuery = query(collection(dbMail, mail.stockKey), where("isSold", "==", false));
                    const snapshot = await getCountFromServer(stockQuery);
                    return { name: mail.type, count: snapshot.data().count };
                } catch (e) { return { name: mail.type, count: 'Error' }; }
            });
            const stockCounts = await Promise.all(stockPromises);
            container.innerHTML = stockCounts.map(stock => `
                <div class="flex justify-between items-center bg-gray-50 p-2 rounded-md">
                    <span class="font-semibold text-gray-700">${stock.name}</span>
                    <span class="font-bold text-lg ${stock.count > 10 ? 'text-green-600' : 'text-red-600'}">${stock.count} pcs</span>
                </div>`).join('');
        }
        
        async function loadUsers(searchTerm = '') {
            const tableBody = document.getElementById('users-table-body');
            tableBody.innerHTML = `<tr><td colspan="5" class="text-center">Loading...</td></tr>`;
            let users = Array.from(allUsersMap.values()).map(user => ({ id: user.tgChatId, ...user }));
            users.sort((a,b) => (b.balance || 0) - (a.balance || 0));

            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                users = users.filter(user => (user.name || '').toLowerCase().includes(term) || (user.tgChatId || '').includes(term));
            }
            renderUsersTable(users);
        }

        function renderUsersTable(users) {
            const tableBody = document.getElementById('users-table-body');
            if (users.length === 0) { tableBody.innerHTML = `<tr><td colspan="5" class="text-center">No users found.</td></tr>`; return; }
            tableBody.innerHTML = users.map(user => {
                const isBlocked = user.isBlocked || false;
                const userDataString = JSON.stringify({ id: user.id, name: user.name || 'N/A', balance: user.balance || 0 }).replace(/"/g, "'");
                
                return `<tr>
                    <td>${user.name || 'N/A'}</td><td>${user.tgChatId}</td>
                    <td>‡ß≥${(user.balance || 0).toFixed(2)}</td>
                    <td><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${isBlocked ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">${isBlocked ? 'Blocked' : 'Active'}</span></td>
                    <td class="space-x-2 whitespace-nowrap">
                        <button class="btn text-xs ${isBlocked ? 'btn-success' : 'btn-danger'}" onclick="window.toggleBlockUser('${user.id}', ${isBlocked})">${isBlocked ? 'Unblock' : 'Block'}</button>
                        <button class="btn text-xs btn-primary" onclick="window.openBalanceModal(${userDataString})">Balance</button>
                    </td></tr>`;
            }).join('');
        }

        window.toggleBlockUser = (userId, isBlocked) => {
            const action = isBlocked ? 'unblock' : 'block';
            showConfirm(`Are you sure you want to ${action} this user?`, async () => {
                await updateDoc(doc(dbUser, "users", userId), { isBlocked: !isBlocked });
                await fetchAllUsers(); // Refresh user map
                showAlert(`User successfully ${action}ed.`);
                loadUsers(document.getElementById('user-search').value);
            });
        };
        
        window.openBalanceModal = (userData) => {
            document.getElementById('balance-user-id').value = userData.id;
            document.getElementById('balance-modal-title').textContent = `Update Balance for ${userData.name}`;
            document.getElementById('current-balance-display').textContent = `‡ß≥${(userData.balance || 0).toFixed(2)}`;
            document.getElementById('balance-form').reset();
            document.getElementById('balance-modal').classList.remove('hidden');
        };

        async function handleBalanceUpdate(e) {
            e.preventDefault();
            const userId = document.getElementById('balance-user-id').value;
            const action = document.getElementById('balance-action').value;
            const amount = parseFloat(document.getElementById('balance-amount').value);
            if (isNaN(amount) || amount < 0) return showAlert("Please enter a valid amount.");
            const userRef = doc(dbUser, "users", userId);
            try {
                await runTransaction(dbUser, async (transaction) => {
                    const userDoc = await transaction.get(userRef);
                    if (!userDoc.exists()) throw new Error("User not found.");
                    const currentBalance = userDoc.data().balance || 0;
                    let newBalance = (action === 'add') ? currentBalance + amount : (action === 'deduct') ? currentBalance - amount : amount;
                    if (newBalance < 0) newBalance = 0;
                    transaction.update(userRef, { balance: newBalance });
                });
                await fetchAllUsers();
                showAlert("User balance updated successfully.");
                document.getElementById('balance-modal').classList.add('hidden');
                loadUsers(document.getElementById('user-search').value);
            } catch (error) { showAlert("Failed to update balance: " + error.message); }
        }
        
        function loadDeposits() {
            const tableBody = document.getElementById('deposits-table-body');
            tableBody.innerHTML = `<tr><td colspan="6" class="text-center">Loading...</td></tr>`;
            const q = query(collection(dbUser, "deposits"), where("status", "==", "pending"), orderBy("requestedAt", "desc"));
            activeListeners['deposits'] = onSnapshot(q, (snapshot) => {
                if (snapshot.empty) { tableBody.innerHTML = `<tr><td colspan="6" class="text-center">No pending deposits.</td></tr>`; return; }
                tableBody.innerHTML = snapshot.docs.map(docSnap => {
                    const req = docSnap.data();
                    return `<tr>
                        <td>${req.userName || 'N/A'}</td><td>‡ß≥${req.amount}</td><td>${req.method}</td>
                        <td>${req.transactionId}</td>
                        <td>${req.requestedAt?.toDate().toLocaleString() || 'N/A'}</td>
                        <td class="space-x-2">
                            <button class="btn btn-success text-xs" onclick="window.handleDeposit('${docSnap.id}', '${req.userId}', ${req.amount}, 'approved')">Approve</button>
                            <button class="btn btn-danger text-xs" onclick="window.handleDeposit('${docSnap.id}', '${req.userId}', 0, 'rejected')">Reject</button>
                        </td></tr>`;
                }).join('');
            });
        }

        async function sendTelegramMessage(chatId, message) {
            if (!TELEGRAM_BOT_TOKEN || !chatId) return;
            const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
            try {
                await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: chatId,
                        text: message,
                        parse_mode: 'HTML'
                    })
                });
            } catch (error) {
                console.error("Failed to send Telegram message:", error);
            }
        }
        
        window.handleDeposit = (depositId, userId, amount, newStatus) => {
            showConfirm(`Are you sure you want to ${newStatus} this ‡ß≥${amount} deposit?`, async () => {
                const depositRef = doc(dbUser, "deposits", depositId);
                const userRef = userId ? doc(dbUser, "users", userId) : null;
                try {
                    await runTransaction(dbUser, async (transaction) => {
                        transaction.update(depositRef, { status: newStatus, processedAt: serverTimestamp() });
                        if (newStatus === 'approved' && userRef) { transaction.update(userRef, { balance: increment(amount) }); }
                    });
                    
                    const notificationTitle = newStatus === 'approved' ? `‚úÖ Deposit Approved` : `‚ùå Deposit Rejected`;
                    const notificationMessage = `Your deposit request of ‡ß≥${amount} has been ${newStatus}.`;

                    await addDoc(collection(dbUser, "notifications"), {
                        recipientId: userId, title: notificationTitle,
                        message: notificationMessage, createdAt: serverTimestamp()
                    });

                    if (newStatus === 'approved') {
                        const telegramMessage = `‚úÖ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ <b>‡ß≥${amount}</b> ‡¶°‡¶ø‡¶™‡ßã‡¶ú‡¶ø‡¶ü ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§ ‡¶π‡ßü‡ßá‡¶õ‡ßá!\n\n‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü‡ßá ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§`;
                        await sendTelegramMessage(userId, telegramMessage);
                    }
                    
                    showAlert(`Deposit has been ${newStatus}.`);
                } catch (e) { showAlert("Operation failed: " + e.message); }
            });
        };
        
        async function loadMailPurchases() {
            const tableBody = document.getElementById('purchases-table-body');
            tableBody.innerHTML = `<tr><td colspan="6" class="text-center">Loading...</td></tr>`;
            const purchasesSnap = await getDocs(query(collection(dbMail, "mail_purchases"), orderBy("purchasedAt", "desc"), limit(200)));
            allPurchases = purchasesSnap.docs.map(docSnap => {
                const p = docSnap.data();
                const userName = allUsersMap.get(p.userId)?.name || p.userId;
                return {
                    saleId: p.saleId || 'N/A',
                    userId: p.userId,
                    date: p.purchasedAt?.toDate().toLocaleString() || 'N/A',
                    userName: userName,
                    mailType: p.type === 'bulk' ? `${p.mailType} (Bulk)` : p.mailType,
                    mailDetails: p.type === 'bulk' ? `${p.quantity || p.mails.length} items` : [p.mail, p.password].filter(Boolean).join(' | '),
                    cost: `‡ß≥${p.cost.toFixed(2)}`
                };
            });
            renderPurchases();
        }

        function renderPurchases(searchTerm = '') {
            const tableBody = document.getElementById('purchases-table-body');
            let filteredPurchases = allPurchases;
            if (searchTerm) { 
                filteredPurchases = allPurchases.filter(p => String(p.saleId).includes(searchTerm) || String(p.userId).includes(searchTerm)); 
            }
            if (filteredPurchases.length === 0) { tableBody.innerHTML = `<tr><td colspan="6" class="text-center">No purchases found.</td></tr>`; return; }
            tableBody.innerHTML = filteredPurchases.map(p => `<tr>
                <td>#${p.saleId}</td><td>${p.date}</td><td>${p.userName}</td>
                <td>${p.mailType}</td><td class="text-xs font-mono">${p.mailDetails}</td><td>${p.cost}</td>
            </tr>`).join('');
        }
        
        async function loadAddStockPage() {
            await fetchAppConfig();
            const selectEl = document.getElementById('mail-type-select-add');
            selectEl.innerHTML = '<option value="">Select mail type...</option>';
            appConfig.mails.forEach(mail => { selectEl.innerHTML += `<option value="${mail.stockKey}">${mail.type}</option>`; });
        }
        
        async function handleAddMails() {
            const stockKey = document.getElementById('mail-type-select-add').value;
            const mailDataRaw = document.getElementById('mail-data-textarea').value;
            if (!stockKey || !mailDataRaw.trim()) return showAlert("Please select a mail type and provide mail data.");
            const lines = mailDataRaw.trim().split(/\r?\n/).filter(line => line.trim() !== '');
            if (lines.length === 0) return showAlert("No valid mail data found.");
            
            showConfirm(`Are you sure you want to add ${lines.length} mails to the '${stockKey}' stock?`, async () => {
                let addedCount = 0; const batchSize = 400; 
                for (let i = 0; i < lines.length; i += batchSize) {
                    const batch = writeBatch(dbMail);
                    const chunk = lines.slice(i, i + batchSize);
                    chunk.forEach(line => {
                        const parts = line.trim().split('|');
                        if (parts.length >= 2) {
                            batch.set(doc(collection(dbMail, stockKey)), { 
                                email: parts[0] || '', password: parts[1] || '', 
                                refresh_token: parts[2] || '', client_id: parts[3] || '', 
                                isSold: false, createdAt: serverTimestamp() 
                            }); addedCount++;
                        }
                    });
                    await batch.commit();
                }
                showAlert(`Successfully added ${addedCount} new mails.`);
                document.getElementById('mail-data-textarea').value = '';
            });
        }
        
        async function handleGlobalMailSearch() {
            const email = document.getElementById('global-mail-search-input').value.trim();
            const searchType = document.getElementById('global-mail-search-type').value;
            const resultsContainer = document.getElementById('global-mail-search-results-container');
            const searchBtn = document.getElementById('global-mail-search-btn');
            
            if (!email) { resultsContainer.innerHTML = '<p class="text-red-500">Please enter an email address.</p>'; return; }
            
            searchBtn.disabled = true; searchBtn.textContent = 'Searching...';
            resultsContainer.innerHTML = '<p>Searching...</p>';
            
            if (searchType === 'stock') {
                await searchInStock(email, resultsContainer);
            } else {
                await searchInSales(email, resultsContainer);
            }
            
            searchBtn.disabled = false; searchBtn.textContent = 'Search';
        }
        
        async function searchInStock(email, container) {
            await fetchAppConfig();
            let foundMails = [];
            const searchPromises = appConfig.mails.map(async (mailType) => {
                try {
                    const q = query(collection(dbMail, mailType.stockKey), where("email", "==", email));
                    const snapshot = await getDocs(q);
                    snapshot.forEach(doc => {
                        foundMails.push({ id: doc.id, stockKey: mailType.stockKey, type: mailType.type, ...doc.data() });
                    });
                } catch (e) { console.error(`Error in ${mailType.stockKey}:`, e.message); }
            });
            await Promise.all(searchPromises);

            if (foundMails.length > 0) {
                container.innerHTML = foundMails.map(mail => `
                    <div class="p-3 bg-gray-50 border rounded-lg flex justify-between items-center">
                        <div>
                           <p><strong>Category:</strong> ${mail.type}</p>
                           <p><strong>Status:</strong> <span class="font-semibold ${mail.isSold ? 'text-red-500' : 'text-green-500'}">${mail.isSold ? 'Sold' : 'Unsold'}</span></p>
                        </div>
                        <button class="btn btn-danger text-xs" onclick="window.deleteSingleFoundMail('${mail.stockKey}', '${mail.id}', this)">Delete</button>
                    </div>`).join('');
            } else {
                container.innerHTML = '<p class="text-yellow-600 font-semibold">No mail found in any stock.</p>';
            }
        }
        
        async function searchInSales(email, container) {
            const q = query(collection(dbMail, "mail_purchases"), where("mail", "==", email), orderBy("purchasedAt", "desc"));
            const snapshot = await getDocs(q);
            
            if (!snapshot.empty) {
                 container.innerHTML = snapshot.docs.map(doc => {
                    const purchase = doc.data();
                    const user = allUsersMap.get(purchase.userId);
                    const userName = user ? user.name : 'Unknown User';
                    const purchaseDate = purchase.purchasedAt.toDate().toLocaleString();
                    return `
                        <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg">
                            <p><strong>Purchased By:</strong> ${userName} (${purchase.userId})</p>
                            <p><strong>Purchase Date:</strong> ${purchaseDate}</p>
                            <p><strong>Sale ID:</strong> #${purchase.saleId || 'N/A'}</p>
                        </div>`;
                }).join('');
            } else {
                container.innerHTML = '<p class="text-yellow-600 font-semibold">No purchase history found for this email.</p>';
            }
        }

        window.deleteSingleFoundMail = (stockKey, docId, btn) => {
            showConfirm("Are you sure you want to permanently delete this mail from stock?", async () => {
                await deleteDoc(doc(dbMail, stockKey, docId));
                showAlert("Mail deleted successfully.");
                btn.parentElement.remove();
            });
        };

        async function loadBulkToolsPage() {
            const container = document.getElementById('bulk-tools-container');
            container.innerHTML = `<p>Loading...</p>`;
            await fetchAppConfig();
            const categories = await Promise.all(appConfig.mails.map(async (mail) => {
                const [unsoldSnap, soldSnap] = await Promise.all([
                    getCountFromServer(query(collection(dbMail, mail.stockKey), where("isSold", "==", false))),
                    getCountFromServer(query(collection(dbMail, mail.stockKey), where("isSold", "==", true)))
                ]);
                return { ...mail, unsoldCount: unsoldSnap.data().count, soldCount: soldSnap.data().count };
            }));
            container.innerHTML = categories.map(cat => `
                <div class="p-4 border rounded-lg bg-gray-50">
                    <h3 class="text-xl font-bold">${cat.type}</h3>
                    <div class="grid grid-cols-2 gap-4 my-2"><div class="text-center p-2 bg-green-100 rounded"><span class="block text-2xl font-bold text-green-700">${cat.unsoldCount}</span><span class="text-sm">Unsold</span></div><div class="text-center p-2 bg-red-100 rounded"><span class="block text-2xl font-bold text-red-700">${cat.soldCount}</span><span class="text-sm">Sold</span></div></div>
                    <div class="flex flex-wrap gap-2"><button class="btn btn-primary text-xs" onclick="window.copyUnsoldMails('${cat.stockKey}')">Copy Unsold</button><button class="btn btn-danger text-xs" onclick="window.deleteMailsByStatus('${cat.stockKey}', false, ${cat.unsoldCount})">Delete Unsold</button><button class="btn bg-gray-700 text-white text-xs" onclick="window.deleteMailsByStatus('${cat.stockKey}', true, ${cat.soldCount})">Delete Sold</button></div>
                </div>`).join('');
        }

        window.copyUnsoldMails = async (stockKey) => {
            const q = query(collection(dbMail, stockKey), where("isSold", "==", false));
            const snapshot = await getDocs(q);
            if (snapshot.empty) return showAlert("No unsold mails.");
            const mailData = snapshot.docs.map(doc => [doc.data().email, doc.data().password, doc.data().refresh_token, doc.data().client_id].filter(Boolean).join('|'));
            await navigator.clipboard.writeText(mailData.join('\n'));
            showAlert(`Copied ${snapshot.size} unsold mails.`);
        }
        
        window.deleteMailsByStatus = (stockKey, isSold, count) => {
            if (count === 0) return;
            showConfirm(`!!! DANGER !!!\nDelete all ${count} ${isSold ? "SOLD" : "UNSOLD"} mails from ${stockKey}?`, async () => {
                const q = query(collection(dbMail, stockKey), where("isSold", "==", isSold), limit(400));
                let snapshot, deletedCount = 0;
                do {
                    snapshot = await getDocs(q); const batch = writeBatch(dbMail);
                    snapshot.docs.forEach(doc => batch.delete(doc.ref));
                    await batch.commit(); deletedCount += snapshot.size;
                } while (!snapshot.empty);
                showAlert(`Deleted ${deletedCount} mails.`); loadBulkToolsPage();
            });
        }
        
        async function handleBroadcastNotification() { const title = document.getElementById('broadcast-title').value; const message = document.getElementById('broadcast-message').value; if (!title || !message) return; showConfirm("Send to ALL users?", async () => { await addDoc(collection(dbUser, 'notifications'), { title, message, createdAt: serverTimestamp(), recipientId: null }); showAlert("Broadcast sent!"); }); }
        async function handleDirectNotification() { const userId = document.getElementById('direct-user-id').value; const title = document.getElementById('direct-title').value; const message = document.getElementById('direct-message').value; if (!userId || !title || !message) return; await addDoc(collection(dbUser, 'notifications'), { title, message, recipientId: userId, createdAt: serverTimestamp() }); showAlert(`Direct notification sent.`); }
        
        async function loadUpdates() {
            const tableBody = document.getElementById('updates-table-body');
            activeListeners['updates'] = onSnapshot(query(collection(dbMail, "updates"), orderBy("createdAt", "desc")), (snapshot) => {
                if(snapshot.empty) { tableBody.innerHTML = `<tr><td colspan="3" class="text-center">No updates.</td></tr>`; return; }
                tableBody.innerHTML = snapshot.docs.map(doc => {
                    const u = {id: doc.id, ...doc.data()}; const updateDataString = JSON.stringify(u).replace(/"/g, "'");
                    return `<tr><td>${u.title}</td><td>${u.createdAt?.toDate().toLocaleDateString() || 'N/A'}</td><td class="space-x-2"><button class="btn text-xs bg-blue-100 text-blue-800" onclick="window.editUpdate(${updateDataString})">Edit</button><button class="btn btn-danger text-xs" onclick="window.deleteUpdate('${u.id}')">Delete</button></td></tr>`;
                }).join('');
            });
        }
        async function handleUpdateSubmit(e) { e.preventDefault(); const id = document.getElementById('update-id').value; const data = { title: document.getElementById('update-title').value, content: document.getElementById('update-content').value, imageUrl: document.getElementById('update-imageUrl').value, }; if(id) await updateDoc(doc(dbMail, "updates", id), data); else await addDoc(collection(dbMail, "updates"), { ...data, createdAt: serverTimestamp() }); showAlert("Update saved!"); resetUpdateForm(); }
        window.editUpdate = (u) => { document.getElementById('update-id').value = u.id; document.getElementById('update-title').value = u.title; document.getElementById('update-content').value = u.content; document.getElementById('update-imageUrl').value = u.imageUrl; document.getElementById('update-form-title').textContent = "Edit Update"; document.getElementById('update-cancel-btn').classList.remove('hidden'); }
        function resetUpdateForm() { document.getElementById('update-form').reset(); document.getElementById('update-id').value = ''; document.getElementById('update-form-title').textContent = "Add New Update"; document.getElementById('update-cancel-btn').classList.add('hidden'); }
        window.deleteUpdate = (id) => showConfirm("Delete this update?", async () => await deleteDoc(doc(dbMail, "updates", id)));

        async function loadSettings() {
            await fetchAppConfig();
            document.getElementById('setting-min-deposit').value = appConfig.minDeposit || '';
            
            const mailTypesContainer = document.getElementById('mail-types-container');
            mailTypesContainer.innerHTML = '';
            (appConfig.mails || []).forEach((mail) => addMailTypeToUI(mail));
            lucide.createIcons();
        }

        function addMailTypeToUI(mail = {}) {
            const container = document.getElementById('mail-types-container');
            const card = document.createElement('div');
            card.className = 'p-4 border-2 border-dashed rounded-lg bg-gray-50 mail-type-card';
            card.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <input type="text" placeholder="Type (e.g., Google)" class="p-2 border rounded" data-field="type" value="${mail.type || ''}" required>
                    <input type="number" step="0.01" placeholder="Price (BDT)" class="p-2 border rounded" data-field="priceBdt" value="${mail.priceBdt || ''}" required>
                    <input type="text" placeholder="Stock Key (e.g., google_mails)" class="p-2 border rounded" data-field="stockKey" value="${mail.stockKey || ''}" required>
                    <input type="url" placeholder="Logo URL" class="p-2 border rounded" data-field="logoUrl" value="${mail.logoUrl || ''}" required>
                    <input type="url" placeholder="API Link (Optional)" class="p-2 border rounded" data-field="apiLink" value="${mail.apiLink || ''}">
                    <select class="p-2 border rounded" data-field="category">
                        <option value="login" ${!mail.category || mail.category === 'login' ? 'selected' : ''}>Login Mail</option>
                        <option value="otp" ${mail.category === 'otp' ? 'selected' : ''}>OTP Mail</option>
                    </select>
                    <input type="number" placeholder="Expiration (Hours)" class="p-2 border rounded" data-field="expirationHours" value="${mail.expirationHours || ''}">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                    <textarea placeholder="Details/Description (for modal)" class="p-2 border rounded w-full" data-field="details" rows="4">${mail.details || ''}</textarea>
                    <textarea placeholder="Feature List (one per line)" class="p-2 border rounded w-full" data-field="featureList" rows="4">${(mail.featureList || []).join('\n')}</textarea>
                </div>
                <button class="btn btn-danger mt-4 text-xs" onclick="this.parentElement.remove()">Remove</button>`;
            container.appendChild(card);
        }

        async function saveAllSettings() {
            showConfirm("Are you sure you want to save all settings? This will overwrite the current configuration.", async () => {
                const newConfig = {
                    minDeposit: parseFloat(document.getElementById('setting-min-deposit').value) || 50,
                    mails: []
                };

                document.querySelectorAll('.mail-type-card').forEach(card => {
                    const mail = {};
                    card.querySelectorAll('[data-field]').forEach(input => {
                        const field = input.dataset.field; let value = input.value.trim();
                        if (field === 'priceBdt') value = parseFloat(value) || 0;
                        else if (field === 'expirationHours') value = value ? parseInt(value) : null;
                        else if (field === 'featureList') value = value.split('\n').map(l => l.trim()).filter(Boolean);
                        mail[field] = value;
                    });
                    if (mail.type && mail.stockKey) newConfig.mails.push(mail);
                });
                await setDoc(doc(dbMail, "config", "main"), newConfig);
                showAlert("All settings saved successfully!");
            });
        }
        
        async function loadSupportLinks() {
            const listContainer = document.getElementById('support-links-list');
            activeListeners['support'] = onSnapshot(query(collection(dbMail, "support_channels"), orderBy("order")), (snapshot) => {
                if (snapshot.empty) { listContainer.innerHTML = '<p class="text-gray-500">No links.</p>'; return; }
                listContainer.innerHTML = snapshot.docs.map(docSnap => {
                    const link = { id: docSnap.id, ...docSnap.data() }; const linkDataString = JSON.stringify(link).replace(/"/g, "'");
                    return `<div class="flex items-center justify-between p-3 bg-gray-100 rounded-lg"><div><p class="font-semibold">${link.name}</p></div><div class="space-x-2"><button class="btn text-xs bg-blue-100 text-blue-800" onclick="window.editSupportLink(${linkDataString})">Edit</button><button class="btn btn-xs btn-danger" onclick="window.deleteSupportLink('${link.id}')">Delete</button></div></div>`;
                }).join('');
            });
        }
        async function handleSupportFormSubmit(e) { e.preventDefault(); const id = document.getElementById('support-id').value; const data = { name: document.getElementById('support-name').value, iconUrl: document.getElementById('support-iconUrl').value, link: document.getElementById('support-link').value, order: parseInt(document.getElementById('support-order').value) || 0, isActive: document.getElementById('support-isActive').checked }; if (id) await updateDoc(doc(dbMail, "support_channels", id), data); else await addDoc(collection(dbMail, "support_channels"), data); showAlert("Support link saved!"); resetSupportForm(); }
        function resetSupportForm() { document.getElementById('support-form').reset(); document.getElementById('support-id').value = ''; document.getElementById('support-form-title').textContent = "Add New Support Link"; document.getElementById('support-cancel-btn').classList.add('hidden'); }
        window.editSupportLink = (link) => { document.getElementById('support-id').value = link.id; document.getElementById('support-name').value = link.name; document.getElementById('support-iconUrl').value = link.iconUrl; document.getElementById('support-link').value = link.link; document.getElementById('support-order').value = link.order; document.getElementById('support-isActive').checked = link.isActive; document.getElementById('support-form-title').textContent = "Edit Support Link"; document.getElementById('support-cancel-btn').classList.remove('hidden'); };
        window.deleteSupportLink = (id) => showConfirm("Delete link?", async () => await deleteDoc(doc(dbMail, "support_channels", id)));
        
        function showAlert(message) { document.getElementById('alert-message').textContent = message; document.getElementById('custom-alert').classList.remove('hidden'); }
        function showConfirm(message, onConfirm) {
            const confirmModal = document.getElementById('custom-confirm');
            document.getElementById('confirm-message').textContent = message;
            confirmModal.classList.remove('hidden');
            const okBtn = document.getElementById('confirm-ok-btn');
            const cancelBtn = document.getElementById('confirm-cancel-btn');
            const cleanup = () => { confirmModal.classList.add('hidden'); okBtn.removeEventListener('click', okListener); cancelBtn.removeEventListener('click', cancelListener); };
            const okListener = () => { onConfirm(); cleanup(); };
            const cancelListener = () => cleanup();
            okBtn.addEventListener('click', okListener, { once: true });
            cancelBtn.addEventListener('click', cancelListener, { once: true });
        }
        
        Object.assign(window, { toggleBlockUser, openBalanceModal, handleDeposit, deleteSingleFoundMail, copyUnsoldMails, deleteMailsByStatus, editUpdate, deleteUpdate, editSupportLink, deleteSupportLink });
    </script>
</body>
</html>
